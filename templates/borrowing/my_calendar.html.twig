{% extends 'backendofficebase.html.twig' %}

{% block title %}Mon calendrier d'emprunts{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css" rel="stylesheet">
<style>
    .personal-calendar {
        max-width: 100%;
        margin: 0 auto;
    }

    .calendar-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
        width: 100%;
        overflow-x: auto;
        overflow-y: visible;
    }

    #personal-calendar {
        width: 100%;
        min-width: 600px;
    }

    .status-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .status-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
    }

    .status-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 8px;
        display: inline-block;
    }

    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .upcoming-returns {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .return-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
    }

    .return-item:hover {
        background-color: #f8f9fa;
    }

    .return-item:last-child {
        border-bottom: none;
    }

    .return-book-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 15px;
    }

    .return-book-info {
        flex-grow: 1;
    }

    .return-book-title {
        font-weight: bold;
        margin-bottom: 2px;
    }

    .return-book-author {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .return-due-date {
        font-size: 0.9rem;
        color: #dc3545;
        font-weight: bold;
    }

    .return-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-overdue {
        background-color: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .empty-state .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    /* Mobile Responsive Styles for Calendar */
    @media (max-width: 768px) {
        .calendar-container {
            padding: 5px !important;
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        #personal-calendar {
            min-width: 600px;
            width: 100%;
        }

        .stats-overview {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 15px !important;
        }

        .stat-card {
            padding: 15px !important;
        }

        .stat-card .stat-icon {
            font-size: 1.5rem !important;
        }

        .stat-card .stat-number {
            font-size: 1.5rem !important;
        }

        .upcoming-returns {
            padding: 15px !important;
        }

        .return-item {
            flex-direction: column;
            text-align: center;
            padding: 10px !important;
        }

        .return-book-image {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }

        .status-legend {
            flex-direction: column;
            gap: 10px;
        }

        /* FullCalendar Mobile Styles */
        .fc {
            font-size: 0.85rem !important;
        }

        .fc-header-toolbar {
            flex-direction: column !important;
            gap: 8px !important;
            margin-bottom: 0.5em !important;
        }

        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            flex-wrap: wrap;
        }

        .fc-toolbar-chunk:first-child,
        .fc-toolbar-chunk:last-child {
            order: 2;
        }

        .fc-toolbar-chunk:nth-child(2) {
            order: 1;
            width: 100%;
        }

        .fc-button {
            font-size: 0.7rem !important;
            padding: 0.3rem 0.6rem !important;
            margin: 2px !important;
        }

        .fc-toolbar-title {
            font-size: 0.95rem !important;
            margin: 0.5rem 0 !important;
        }

        .fc-daygrid-day {
            min-height: 70px !important;
            height: auto !important;
        }

        .fc-daygrid-day-number {
            font-size: 0.8rem !important;
            padding: 3px 4px !important;
        }

        .fc-event {
            font-size: 0.65rem !important;
            padding: 1px 3px !important;
            margin: 1px 0 !important;
            line-height: 1.3 !important;
        }

        .fc-event-title {
            font-size: 0.65rem !important;
            padding: 0 !important;
        }

        .fc-daygrid-event {
            margin: 1px 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .fc-scrollgrid {
            font-size: 0.8rem !important;
        }

        .fc-col-header-cell {
            font-size: 0.7rem !important;
            padding: 4px 2px !important;
            font-weight: 600 !important;
        }

        .fc-col-header-cell-cushion {
            padding: 2px !important;
        }

        .fc-daygrid-more-link {
            font-size: 0.65rem !important;
            padding: 2px 4px !important;
        }
    }

    @media (max-width: 576px) {
        .calendar-container {
            padding: 3px !important;
        }

        #personal-calendar {
            min-width: 500px;
        }

        .stats-overview {
            grid-template-columns: 1fr !important;
        }

        .fc-button {
            font-size: 0.65rem !important;
            padding: 0.2rem 0.4rem !important;
        }

        .fc-toolbar-title {
            font-size: 0.9rem !important;
        }

        .fc-daygrid-day {
            min-height: 50px !important;
        }

        .fc-daygrid-day-number {
            font-size: 0.75rem !important;
        }

        .fc-event {
            font-size: 0.65rem !important;
        }

        .fc-col-header-cell {
            font-size: 0.7rem !important;
            padding: 3px 1px !important;
        }
    }
</style>
{% endblock %}

{% block body %}
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-check text-primary mr-2"></i>Mon calendrier d'emprunts
        </h1>
        <p class="mb-0 text-muted">Suivez tous vos emprunts et retours</p>
    </div>
    <a href="{{ path('app_loan_index') }}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-list fa-sm text-white-50"></i> Voir la liste détaillée
    </a>
</div>

<!-- Stats Overview -->
<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-icon text-primary">
            <i class="fas fa-book-reader"></i>
        </div>
        <div class="stat-number text-primary">{{ app.user.getActiveLoans()|length }}</div>
        <div class="stat-label">Emprunts actifs</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number text-success">
            {{ app.user.loans|filter(loan => loan.status == 'returned')|length }}
        </div>
        <div class="stat-label">Livres retournés</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number text-warning">
            {{ app.user.loans|filter(loan => loan.status == 'requested' or loan.status == 'approved')|length }}
        </div>
        <div class="stat-label">En attente</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-danger">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-number text-danger">
            {{ app.user.loans|filter(loan => loan.status == 'overdue')|length }}
        </div>
        <div class="stat-label">En retard</div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <!-- Upcoming Returns -->
        <div class="upcoming-returns">
            <h5 class="mb-3">
                <i class="fas fa-calendar-times text-warning mr-2"></i>Prochains retours
            </h5>

            {% set upcomingReturns = app.user.loans|filter(loan => loan.status == 'active' and loan.dueDate)|sort((a, b) => a.dueDate <=> b.dueDate) %}

            {% if upcomingReturns %}
                {% for loan in upcomingReturns %}
                    <div class="return-item">
                        <img src="{{ loan.livre.image ? asset('uploads/images/' ~ loan.livre.image) : asset('img/undraw_profile.svg') }}"
                             alt="{{ loan.livre.titre }}" class="return-book-image">
                        <div class="return-book-info">
                            <div class="return-book-title">{{ loan.livre.titre }}</div>
                            <div class="return-book-author">{{ loan.livre.auteur.prenom }} {{ loan.livre.auteur.nom }}</div>
                            <div class="return-due-date">
                                <i class="fas fa-calendar mr-1"></i>
                                {{ loan.dueDate|date('d/m/Y') }}
                                {% if loan.getDaysRemaining() <= 1 %}
                                    <span class="text-danger">(Demain !)</span>
                                {% elseif loan.getDaysRemaining() < 0 %}
                                    <span class="text-danger">(En retard)</span>
                                {% else %}
                                    ({{ loan.getDaysRemaining() }} jours)
                                {% endif %}
                            </div>
                        </div>
                        <div class="return-status {{ loan.status == 'overdue' ? 'status-overdue' : 'status-active' }}">
                            {{ loan.getStatusLabel() }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h6>Aucun emprunt actif</h6>
                    <p class="mb-0">Vous n'avez pas d'emprunts en cours.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-8">
        <!-- Status Legend -->
        <div class="status-legend">
            <div class="status-item">
                <span class="status-color" style="background-color: #28a745;"></span>
                <span>En cours</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #dc3545;"></span>
                <span>En retard</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #6c757d;"></span>
                <span>Retourné</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #ffc107;"></span>
                <span>Demandé</span>
            </div>
            <div class="status-item">
                <span class="status-color" style="background-color: #17a2b8;"></span>
                <span>Approuvé</span>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div id="personal-calendar" class="personal-calendar"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/locales/fr.global.min.js"></script>

<script>
function initPersonalCalendar() {
    const calendarEl = document.getElementById('personal-calendar');
    
    // Verify element exists
    if (!calendarEl) {
        console.error('Calendar element not found');
        return;
    }
    
    // Prevent double initialization
    if (calendarEl.dataset.initialized === 'true') {
        return;
    }
    calendarEl.dataset.initialized = 'true';
    
    // Clear any existing calendar
    calendarEl.innerHTML = '';
    
    // Parse events safely
    let events = [];
    try {
        const rawEvents = {{ events|raw }};
        events = Array.isArray(rawEvents) ? rawEvents : [];
        console.log('Calendar events loaded:', events);
    } catch (error) {
        console.error('Error parsing calendar events:', error);
        events = [];
    }

    // Check if FullCalendar is available (wait with delay if needed)
    const checkCalendar = setInterval(function() {
        if (typeof FullCalendar !== 'undefined') {
            clearInterval(checkCalendar);
            renderCalendar();
        }
    }, 100);

    // Timeout after 5 seconds
    setTimeout(function() {
        clearInterval(checkCalendar);
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar library failed to load');
        } else {
            // Try to initialize even if checkCalendar didn't fire
            if (!calendarEl.dataset.initialized || calendarEl.dataset.initialized === 'false') {
                renderCalendar();
            }
        }
    }, 5000);

    function renderCalendar() {
        try {
            // Detect mobile device
            const isMobile = window.innerWidth <= 768;
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                height: 'auto',
                events: events,
                eventDisplay: 'block',
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false
                },
                dayMaxEvents: isMobile ? 1 : true,
                moreLinkClick: isMobile ? 'popover' : 'week',
                headerToolbar: {
                    left: isMobile ? 'prev,next' : 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth' : 'dayGridMonth,dayGridWeek'
                },
                buttonText: {
                    today: 'Aujourd\'hui',
                    month: 'Mois',
                    week: 'Semaine'
                },
                eventClick: function(info) {
                    // Open book details in new tab
                    if (info.event.url) {
                        window.open(info.event.url, '_blank');
                    }
                    info.jsEvent.preventDefault();
                },
                eventDidMount: function(info) {
                    // Add tooltip with book title
                    info.el.setAttribute('title', info.event.title);
                },
                datesSet: function(info) {
                    console.log('Calendar rendered for period:', info.start, 'to', info.end);
                },
                // Responsive event rendering
                eventContent: function(arg) {
                    if (isMobile) {
                        return {
                            html: '<div style="font-size: 0.65rem; line-height: 1.2; padding: 1px 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">' + arg.event.title + '</div>'
                        };
                    }
                    return {};
                }
            });

            calendar.render();
            console.log('Calendar initialized successfully');
            
            // Handle window resize for responsive calendar
            let resizeTimer;
            const resizeHandler = function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    calendar.updateSize();
                }, 250);
            };
            
            window.addEventListener('resize', resizeHandler);
        } catch (error) {
            console.error('Error initializing calendar:', error);
        }
    }

    // If FullCalendar is already loaded, initialize immediately
    if (typeof FullCalendar !== 'undefined') {
        renderCalendar();
    }
}

// Support both regular page load and Turbo navigation
document.addEventListener('DOMContentLoaded', initPersonalCalendar);
document.addEventListener('turbo:load', initPersonalCalendar);
document.addEventListener('turbo:render', initPersonalCalendar);
</script>
{% endblock %}